<?php

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Modus und Ansicht
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

$data['modus'] = CSiteManager::getMode();
$data['view'] = C2C_Modus($data['modus']);

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Das Objekt
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

$Beitrag = new CBeitrag();

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Modus: speichern!
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
if (MODE_SAVE == $data['modus']) {
    if ($_POST['beitrag_id']) {
        $Beitrag->load($_POST['beitrag_id']);
    }

    $Beitrag->setBezeichnung($_POST['bezeichnung']);
    $Beitrag->setBeitrag($_POST['beitrag']);

    $Beitrag->save();
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Modus: lÃ¶schen!
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

if (MODE_DROP == $data['modus']) {
    $Beitrag->load($_POST['drop']);
    $Beitrag->delete();
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Detailansicht
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

if (VIEW_DETAIL == $data['view']) {
    if (MODE_EDIT == $data['modus']) {
        $Beitrag->load((int) $_POST['edit']);
    }
    $data['beitrag'] = $Beitrag;
}

if (VIEW_LIST == $data['view']) {
    //------------------------------------------------------------------------------------------------------------------
    // Auswahl
    //------------------------------------------------------------------------------------------------------------------
    $query = 'SELECT beitrag_id '.
             'FROM beitraege';

    //------------------------------------------------------------------------------------------------------------------
    // Abfrage
    //------------------------------------------------------------------------------------------------------------------

    $data['beitraege_array'] = array();
    if (!$result = mysqli_query(CDBConnection::getDB(), $query)) {
        throw new Exception(mysqli_error(CDBConnection::getDB()));
    }
    while ($row = mysqli_fetch_row($result)) {
        $data['beitraege_array'][] = new CBeitrag($row[0]);
    }
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// RETURN
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

return new CTemplateData($data);
