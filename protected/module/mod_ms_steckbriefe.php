<?php
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Ansicht
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

$data['view'] = ((isset($_GET['athlet_id']))?(VIEW_DETAIL):(VIEW_LIST));

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Das Objekt
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

$Mitglied = new CMitglied();

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Detailansicht
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

if(VIEW_DETAIL == $data['view'])
{
	$Mitglied->load((int)$_GET['athlet_id']);
	$data['mitglied'] = $Mitglied;
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Filterung/Sortierung
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

$data['fltr1'] = ((isset($_GET['fltr1']))?((int)$_GET['fltr1']):(0));

$data['fs_string'] = '';
$data['fs_string'] .= (($s = $data['fltr1'])?('&amp;fltr1='.$s):(''));

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Übersicht
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

if(VIEW_LIST == $data['view'])
{
	//--------------------------------------------------------------------------------------------------------------------
	// Auswahl
	//--------------------------------------------------------------------------------------------------------------------
	$query = 'SELECT a.athlet_id '.
	         'FROM (athleten a INNER JOIN _v2_mitglieder_aklagruppe makl ON a.athlet_id=makl.athlet_id) '.
	         'INNER JOIN athleten_mitglieder am ON a.athlet_id=am.athlet_id';

	//--------------------------------------------------------------------------------------------------------------------
	// Filterung
	//--------------------------------------------------------------------------------------------------------------------
	$query_where = array();

	$query_where[] = 'am.ausblenden=0';
	if($data['fltr1']) {$query_where[] = 'makl.aklagruppe'.((4==$data['fltr1'])?(' IS NULL'):('='.$data['fltr1']));}

	foreach($query_where as $i => $clause) {$query .= (($i)?(' AND '):(' WHERE ')).$clause;}

	//--------------------------------------------------------------------------------------------------------------------
	// Sortierung
	//--------------------------------------------------------------------------------------------------------------------
	$query .= ' ORDER BY a.nachname, a.vorname';

	//--------------------------------------------------------------------------------------------------------------------
	// Abfrage
	//--------------------------------------------------------------------------------------------------------------------
	$data['stichtag'] = S2S_Datum_MySql2Deu(CDBConnection::getInstance()->getStichtag());

	// MitgliedArray
	$data['mitglied_array_'.S_HERR] = array();
	$data['mitglied_array_'.S_DAME] = array();
	if(!$result = mysqli_query(CDBConnection::getDB(), $query)) {throw new Exception(mysqlil_error(CDBConnection::getDB()));}
	while($row = mysqli_fetch_row($result)) {
		$TmpMitglied = new CMitglied($row[0]);
		$data['mitglied_array_'.$TmpMitglied->getAnrede()][] = $TmpMitglied;
	}
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// RETURN
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

return new CTemplateData($data);
?>